generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  instructor Instructor?
  student    Student?

  @@map("users")
}

model Instructor {
  id      String   @id @default(cuid())
  userId  String   @unique
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exams   Exam[]
  courses Course[] @relation("CourseInstructors")

  @@map("instructors")
}

model Student {
  id          String       @id @default(cuid())
  userId      String       @unique
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  submissions Submission[]
  courses     Course[]     @relation("CourseStudents")

  @@map("students")
}

model Course {
  id            String      @id @default(cuid())
  courseCode    String
  courseName    String
  sectionType   SectionType
  sectionNumber String
  academicYear  String
  semester      Semester
  isActive      Boolean     @default(true)

  // Relations
  instructors Instructor[] @relation("CourseInstructors")
  students    Student[]    @relation("CourseStudents")
  exams       Exam[]       @relation("CourseExams")

  @@unique([courseCode, sectionType, academicYear, semester, sectionNumber])
  @@map("courses")
}

model Exam {
  id              String    @id @default(cuid())
  title           String
  description     String?   @db.Text
  duration        Int?      @db.UnsignedInt
  totalMarks      Int?      @db.UnsignedInt
  questions       Json? // {question, model_answer, points, type}
  type            ExamType
  deadline        DateTime?
  modelAnswer     String?   @db.Text
  rubric          String?   @db.Text
  rubricLink      String?
  modelAnswerFile String?
  rubricFile      String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  instructorId String
  instructor   Instructor   @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  submissions  Submission[]
  courseId     String?
  course       Course?      @relation("CourseExams", fields: [courseId], references: [id], onDelete: SetNull)

  @@index([instructorId])
  @@index([courseId])
  @@index([createdAt])
  @@map("exams")
}

model Submission {
  id              String           @id @default(cuid())
  originalAnswers Json // {answer, points}
  marks           Int?             @db.UnsignedInt
  feedback        String?          @db.Text
  status          SubmissionStatus @default(PENDING)
  gradedAt        DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  fileLink        String

  // Relations
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  examId    String
  exam      Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([studentId, examId])
  @@index([studentId])
  @@index([examId])
  @@index([status])
  @@index([gradedAt])
  @@map("submissions")
}

enum ExamType {
  MCQ
  TRUE_FALSE
  SHORT_ANSWER
  MIXED
}

enum SubmissionStatus {
  PENDING
  GRADED
}

enum SectionType {
  LECTURE
  LAB
  TUTORIAL
}

enum Semester {
  FALL
  SPRING
  SUMMER
}
