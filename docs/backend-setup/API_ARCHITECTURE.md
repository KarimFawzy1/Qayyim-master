# ğŸ—ï¸ Qayyim API Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     QAYYIM FRONTEND                          â”‚
â”‚              (Next.js 15.3.3 - Your UI)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTP/JSON Requests
                      â”‚ JWT Authentication
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API LAYER (Next.js)                        â”‚
â”‚                     /api/v1/*                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚    AUTH     â”‚  â”‚   TEACHER    â”‚  â”‚   STUDENT    â”‚       â”‚
â”‚  â”‚  Endpoints  â”‚  â”‚  Endpoints   â”‚  â”‚  Endpoints   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Uses
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   UTILITY LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Auth   â”‚ â”‚ Prisma â”‚ â”‚ S3  â”‚ â”‚ Email â”‚ â”‚Validationâ”‚  â”‚
â”‚  â”‚ (JWT)    â”‚ â”‚(Client)â”‚ â”‚(AWS)â”‚ â”‚(Resend)â”‚ â”‚  (Zod)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚            â”‚
         â–¼            â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MySQL  â”‚   â”‚ AWS S3 â”‚   â”‚ Resend â”‚
    â”‚Databaseâ”‚   â”‚ Files  â”‚   â”‚ Email  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Endpoint Structure

```
/api/v1/
â”‚
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ register/           POST   - User registration
â”‚   â”œâ”€â”€ login/              POST   - User login
â”‚   â”œâ”€â”€ forgot-password/    POST   - Password reset request
â”‚   â””â”€â”€ me/                 GET    - Get current user
â”‚
â”œâ”€â”€ teacher/
â”‚   â”œâ”€â”€ dashboard/          GET    - Dashboard statistics
â”‚   â”œâ”€â”€ exams/              GET    - List all exams
â”‚   â”‚                       POST   - Create new exam
â”‚   â”œâ”€â”€ exams/[examId]/
â”‚   â”‚   â”œâ”€â”€ route           GET    - Get exam details
â”‚   â”‚   â”‚                   PUT    - Update exam
â”‚   â”‚   â”‚                   DELETE - Delete exam
â”‚   â”‚   â””â”€â”€ results/
â”‚   â”‚       â”œâ”€â”€ route       GET    - View submissions
â”‚   â”‚       â””â”€â”€ download/   GET    - Download CSV
â”‚   â”œâ”€â”€ grade/
â”‚   â”‚   â””â”€â”€ [submissionId]/ POST   - Grade submission
â”‚   â””â”€â”€ grievances/
â”‚       â”œâ”€â”€ route           GET    - List grievances
â”‚       â””â”€â”€ [grievanceId]/  GET    - View grievance
â”‚                           PUT    - Respond to grievance
â”‚
â””â”€â”€ student/
    â”œâ”€â”€ dashboard/          GET    - Dashboard data
    â”œâ”€â”€ exams/              GET    - Browse exams
    â”œâ”€â”€ exams/[examId]/     GET    - Exam details
    â”œâ”€â”€ submissions/        POST   - Submit answer
    â”œâ”€â”€ results/            GET    - All results
    â”œâ”€â”€ results/[examId]/   GET    - Detailed result
    â””â”€â”€ grievances/         GET    - List grievances
                            POST   - Submit grievance
```

## Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                                   â”‚  Server â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                             â”‚
     â”‚  POST /api/v1/auth/register                â”‚
     â”‚  { name, email, password, role }           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                             â”‚
     â”‚                              Validate Input â”‚
     â”‚                              Hash Password  â”‚
     â”‚                              Create User    â”‚
     â”‚                              Generate JWT   â”‚
     â”‚                                             â”‚
     â”‚  { user: {...}, token: "eyJ..." }          â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                             â”‚
     â”‚  Store token in localStorage                â”‚
     â”‚                                             â”‚
     â”‚  Future Requests with Token:                â”‚
     â”‚  Authorization: Bearer eyJ...               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                             â”‚
     â”‚                              Verify Token   â”‚
     â”‚                              Extract User   â”‚
     â”‚                              Check Role     â”‚
     â”‚                              Process Requestâ”‚
     â”‚                                             â”‚
     â”‚  Response Data                              â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                             â”‚
```

## Request/Response Flow

```
1. CLIENT REQUEST
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/v1/teacher/exams           â”‚
   â”‚ Headers:                             â”‚
   â”‚   Authorization: Bearer eyJ...       â”‚
   â”‚   Content-Type: application/json     â”‚
   â”‚ Body:                                â”‚
   â”‚   {                                  â”‚
   â”‚     "title": "CS101 Midterm",        â”‚
   â”‚     "course": "CS101",               â”‚
   â”‚     "type": "MIXED"                  â”‚
   â”‚   }                                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
2. MIDDLEWARE LAYER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â€¢ Extract JWT token                  â”‚
   â”‚ â€¢ Verify token signature             â”‚
   â”‚ â€¢ Decode payload                     â”‚
   â”‚ â€¢ Check role (TEACHER required)      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
3. VALIDATION LAYER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â€¢ Zod schema validation              â”‚
   â”‚ â€¢ Type checking                      â”‚
   â”‚ â€¢ Required field verification        â”‚
   â”‚ â€¢ Data sanitization                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
4. BUSINESS LOGIC
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â€¢ Process request                    â”‚
   â”‚ â€¢ Database operations (Prisma)       â”‚
   â”‚ â€¢ File operations (S3)               â”‚
   â”‚ â€¢ Email operations (Resend)          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
5. RESPONSE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ {                                    â”‚
   â”‚   "success": true,                   â”‚
   â”‚   "data": {                          â”‚
   â”‚     "id": "clx123...",               â”‚
   â”‚     "title": "CS101 Midterm",        â”‚
   â”‚     ...                              â”‚
   â”‚   },                                 â”‚
   â”‚   "message": "Exam created",         â”‚
   â”‚   "statusCode": 201                  â”‚
   â”‚ }                                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     User     â”‚
â”‚              â”‚
â”‚ id           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ email        â”‚               â”‚
â”‚ password     â”‚               â”‚ teacherId
â”‚ name         â”‚               â”‚
â”‚ role         â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                       â”‚
       â”‚ studentId         â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                   â”‚    Exam    â”‚
       â”‚                   â”‚            â”‚
       â”‚                   â”‚ id         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                   â”‚ title      â”‚          â”‚
       â”‚                   â”‚ course     â”‚          â”‚
       â”‚                   â”‚ type       â”‚          â”‚
       â”‚                   â”‚ modelAnswerâ”‚          â”‚
       â”‚                   â”‚ rubric     â”‚          â”‚
       â”‚                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
       â”‚                       â”‚                   â”‚
       â”‚                       â”‚ examId            â”‚
       â”‚                       â”‚              examIdâ”‚
       â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Submission â”‚          â”‚
                           â”‚            â”‚          â”‚
                           â”‚ id         â”‚          â”‚
                           â”‚ studentId  â”‚          â”‚
                           â”‚ examId     â”‚          â”‚
                           â”‚ answer     â”‚          â”‚
                           â”‚ score      â”‚          â”‚
                           â”‚ feedback   â”‚          â”‚
                           â”‚ status     â”‚          â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                                                   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Grievance   â”‚
   â”‚              â”‚
   â”‚ id           â”‚
   â”‚ studentId    â”‚
   â”‚ examId       â”‚
   â”‚ type         â”‚
   â”‚ details      â”‚
   â”‚ status       â”‚
   â”‚ response     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           LAYER 1: TRANSPORT SECURITY           â”‚
â”‚  â€¢ HTTPS (production)                           â”‚
â”‚  â€¢ Secure headers                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LAYER 2: AUTHENTICATION                 â”‚
â”‚  â€¢ JWT token verification                       â”‚
â”‚  â€¢ Token expiration check                       â”‚
â”‚  â€¢ Signature validation                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LAYER 3: AUTHORIZATION                 â”‚
â”‚  â€¢ Role-based access control (RBAC)             â”‚
â”‚  â€¢ Resource ownership verification              â”‚
â”‚  â€¢ Permission checks                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           LAYER 4: INPUT VALIDATION             â”‚
â”‚  â€¢ Zod schema validation                        â”‚
â”‚  â€¢ Type checking                                â”‚
â”‚  â€¢ SQL injection prevention (Prisma)            â”‚
â”‚  â€¢ XSS prevention                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LAYER 5: DATA PROTECTION               â”‚
â”‚  â€¢ Password hashing (bcrypt)                    â”‚
â”‚  â€¢ Sensitive data filtering                     â”‚
â”‚  â€¢ Secure password reset                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Examples

### Example 1: Student Submits Answer

```
1. Student clicks "Submit Answer"
   â†“
2. Frontend sends POST /api/v1/student/submissions
   {
     examId: "clx123",
     originalAnswer: "Binary search tree is..."
   }
   â†“
3. API validates JWT (student role)
   â†“
4. Validates input with Zod
   â†“
5. Checks if student already submitted
   â†“
6. Creates submission in database
   â†“
7. Increments exam's totalSubmissions
   â†“
8. Returns success response
   â†“
9. Frontend shows confirmation
```

### Example 2: Teacher Grades Submission

```
1. Teacher views submission details
   â†“
2. Teacher enters score and feedback
   â†“
3. Frontend sends POST /api/v1/teacher/grade/[id]
   {
     score: 85,
     feedbackSummary: "Good work...",
     feedback: {
       highlightedAnswer: "...",
       detailedFeedback: "..."
     }
   }
   â†“
4. API validates JWT (teacher role)
   â†“
5. Validates exam ownership
   â†“
6. Updates submission with grade
   â†“
7. Sets status to GRADED
   â†“
8. Updates exam's gradedSubmissions count
   â†“
9. Returns updated submission
   â†“
10. Frontend shows success message
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Request   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€ Invalid Token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ 401 Unauthorized
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€ Wrong Role â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ 403 Forbidden
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€ Validation Error â”€â”€â”€â”€â”€â”€â”€â–¶ 400 Bad Request
       â”‚                                  (with details)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€ Not Found â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ 404 Not Found
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€ Duplicate Entry â”€â”€â”€â”€â”€â”€â”€â”€â–¶ 409 Conflict
       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€ Server Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ 500 Internal Error
```

## File Storage Architecture (S3)

```
AWS S3 Bucket: qayyim-file-storage
â”‚
â”œâ”€â”€ exams/
â”‚   â”œâ”€â”€ {examId}/
â”‚   â”‚   â”œâ”€â”€ model-answer.pdf
â”‚   â”‚   â””â”€â”€ rubric.pdf
â”‚   â”‚
â”‚   â””â”€â”€ {examId}/
â”‚       â””â”€â”€ model-answer.docx
â”‚
â”œâ”€â”€ grievances/
â”‚   â””â”€â”€ {grievanceId}/
â”‚       â””â”€â”€ supporting-document.pdf
â”‚
â””â”€â”€ submissions/
    â””â”€â”€ {submissionId}/
        â””â”€â”€ answer-sheet.pdf

Flow:
1. Frontend requests signed upload URL
2. Backend generates signed URL (1 hour expiry)
3. Frontend uploads file directly to S3
4. Frontend sends S3 URL to backend
5. Backend saves URL in database
```

## Performance Optimizations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DATABASE OPTIMIZATIONS          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Indexes on foreign keys               â”‚
â”‚ â€¢ Indexes on frequently queried fields  â”‚
â”‚ â€¢ Efficient query patterns              â”‚
â”‚ â€¢ Proper use of select/include          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          API OPTIMIZATIONS              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Single query for related data         â”‚
â”‚ â€¢ Pagination for large lists (future)   â”‚
â”‚ â€¢ Computed fields cached in DB          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        SECURITY OPTIMIZATIONS           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Password hashing with 10 rounds       â”‚
â”‚ â€¢ JWT with reasonable expiration        â”‚
â”‚ â€¢ Email enumeration prevention          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Scalability Considerations

```
Current Architecture:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚â”€â”€â”€â”€â–¶â”‚    API   â”‚â”€â”€â”€â”€â–¶â”‚ Database â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Future Scalability:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚â”€â”€â”€â”€â–¶â”‚ Load Balancerâ”‚â”€â”€â”€â”€â–¶â”‚  API 1   â”‚â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                     â”‚
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  API 2   â”‚â”€â”€â”¼â”€â–¶â”‚ Database â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                     â”‚  API 3   â”‚â”€â”€â”˜
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Additional Services:
â€¢ Redis cache for sessions
â€¢ CDN for static files
â€¢ Database read replicas
â€¢ Queue system for AI grading
â€¢ Monitoring and logging
```

## Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CURRENT INTEGRATIONS             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… MySQL Database (Prisma)               â”‚
â”‚ âœ… AWS S3 (File Storage)                 â”‚
â”‚ âœ… Resend (Email Service)                â”‚
â”‚ âœ… JWT (Authentication)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FUTURE INTEGRATIONS              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â­ï¸ Python Flask (AI Grading)             â”‚
â”‚ â­ï¸ OCR Service (Answer Extraction)       â”‚
â”‚ â­ï¸ WebSocket (Real-time Updates)         â”‚
â”‚ â­ï¸ Analytics Service                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This architecture is designed to be:

- **Scalable**: Can handle growth in users and data
- **Secure**: Multiple layers of security
- **Maintainable**: Clean separation of concerns
- **Extensible**: Easy to add new features
- **Reliable**: Proper error handling
- **Performant**: Optimized queries and caching
